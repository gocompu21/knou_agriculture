{% extends "base.html" %}

{% block title %}{{ subject.name }} | 한울회 A+ 학습시스템{% endblock %}

{% block extra_css %}
<style>
    /* ══════════ Breadcrumb ══════════ */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.82rem;
        color: var(--muted);
        margin-bottom: 20px;
    }

    .breadcrumb a {
        color: var(--forest);
        text-decoration: none;
        font-weight: 700;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .breadcrumb .sep {
        color: var(--line);
    }

    /* ══════════ Page Header ══════════ */
    .page-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 24px;
    }

    .grade-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        font-size: 0.82rem;
        font-weight: 800;
        color: #fff;
        flex-shrink: 0;
    }

    .grade-badge.g1 { background: #4caf7a; }
    .grade-badge.g2 { background: #3d9ed6; }
    .grade-badge.g3 { background: #e0943a; }
    .grade-badge.g4 { background: #c4604a; }

    .page-header-text h1 {
        font-size: 1.5rem;
        color: var(--forest);
        line-height: 1.3;
    }

    .page-header-text p {
        font-size: 0.88rem;
        color: var(--muted);
        margin-top: 2px;
    }

    /* ══════════ Tab Navigation ══════════ */
    .tab-nav {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 24px;
        gap: 0;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 12px 20px;
        font-size: 0.92rem;
        font-weight: 700;
        color: #888;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-family: "SUIT", sans-serif;
        position: relative;
    }

    .tab-btn:hover {
        color: var(--forest);
    }

    .tab-btn.active {
        color: var(--forest);
        border-bottom-color: var(--forest);
    }

    .tab-btn .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 700;
        margin-left: 6px;
        vertical-align: 1px;
    }

    .tab-btn .badge-wrong {
        background: #fee2e2;
        color: #d93025;
    }

    /* ══════════ Tab Content ══════════ */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ══════════ Year Grid ══════════ */
    .year-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
    }

    .year-card {
        border: 1px solid #d7e3d7;
        background: linear-gradient(180deg, #ffffff 0%, #f8fcf5 100%);
        border-radius: 16px;
        padding: 22px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .year-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(30, 70, 42, 0.1);
    }

    .year-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .year-card-header h3 {
        font-size: 1.15rem;
        color: #1d5536;
    }

    .q-count {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--forest);
        background: var(--mint);
        padding: 3px 10px;
        border-radius: 6px;
    }

    .mode-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.88rem;
        font-weight: 700;
        font-family: "SUIT", sans-serif;
        transition: transform 0.15s, box-shadow 0.15s;
        width: 100%;
    }

    .mode-btn:hover {
        transform: translateY(-1px);
    }

    .mode-btn .mode-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .mode-btn .mode-info { flex: 1; }
    .mode-btn .mode-name { display: block; line-height: 1.3; }
    .mode-btn .mode-desc {
        display: block;
        font-size: 0.76rem;
        font-weight: 500;
        opacity: 0.7;
        margin-top: 1px;
    }

    .mode-btn.study {
        background: #e5f5e0;
        color: #1d5536;
        border: 1px solid #c8e4c2;
    }
    .mode-btn.study:hover { box-shadow: 0 4px 14px rgba(76, 175, 122, 0.25); }
    .mode-btn.study .mode-icon { background: #4caf7a; color: #fff; }

    .mode-btn.solve {
        background: #fff3e0;
        color: #7a4a0a;
        border: 1px solid #f0d8a8;
    }
    .mode-btn.solve:hover { box-shadow: 0 4px 14px rgba(224, 148, 58, 0.25); }
    .mode-btn.solve .mode-icon { background: #e0943a; color: #fff; }

    /* ══════════ Mock Exam Tab ══════════ */
    .mock-card {
        max-width: 500px;
        margin: 0 auto;
        text-align: center;
        padding: 40px 30px;
        border: 1px solid #d7e3d7;
        background: linear-gradient(180deg, #ffffff 0%, #f8fcf5 100%);
        border-radius: 16px;
    }

    .mock-card h2 {
        font-size: 1.3rem;
        color: var(--forest);
        margin-bottom: 12px;
    }

    .mock-card p {
        color: #666;
        font-size: 0.92rem;
        margin-bottom: 8px;
        line-height: 1.6;
    }

    .mock-start-btn {
        display: inline-block;
        margin-top: 20px;
        padding: 14px 40px;
        background: var(--forest);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        font-family: "SUIT", sans-serif;
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .mock-start-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 14px rgba(30, 70, 42, 0.25);
    }

    /* ══════════ Wrong Answers Tab ══════════ */
    .wrong-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding: 16px 20px;
        background: #fef9f0;
        border: 1px solid #f0d8a8;
        border-radius: 12px;
    }

    .wrong-summary-text {
        font-size: 0.95rem;
        color: #555;
    }

    .wrong-summary-text strong {
        color: #d93025;
        font-size: 1.2rem;
    }

    .wrong-summary-btn {
        padding: 10px 20px;
        background: #ff6b35;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        font-family: "SUIT", sans-serif;
        transition: transform 0.15s;
        white-space: nowrap;
    }

    .wrong-summary-btn:hover {
        transform: translateY(-1px);
    }

    .session-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .session-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        border: 1px solid #d7e3d7;
        background: linear-gradient(180deg, #ffffff 0%, #f8fcf5 100%);
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .session-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 70, 42, 0.08);
    }

    .session-mode {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.78rem;
        font-weight: 700;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .session-mode.exam {
        background: #fff3e0;
        color: #7a4a0a;
    }

    .session-mode.mock {
        background: #e8eaf6;
        color: #3949ab;
    }

    .session-info {
        flex: 1;
        min-width: 0;
    }

    .session-label {
        font-weight: 700;
        font-size: 0.95rem;
        color: #333;
    }

    .session-date {
        font-size: 0.8rem;
        color: #999;
        margin-top: 2px;
    }

    .session-stats {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .session-score {
        font-size: 1.1rem;
        font-weight: 800;
    }

    .session-wrong-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 700;
        background: #fee2e2;
        color: #d93025;
    }

    .session-link {
        padding: 6px 14px;
        background: #e5f5e0;
        color: #1d5536;
        border: 1px solid #c8e4c2;
        border-radius: 8px;
        font-size: 0.82rem;
        font-weight: 600;
        text-decoration: none;
        white-space: nowrap;
        transition: background 0.15s;
    }

    .session-link:hover {
        background: #d4edda;
    }

    .session-del-btn {
        padding: 6px 10px;
        background: transparent;
        color: #bbb;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: color 0.15s, background 0.15s;
        font-family: inherit;
        line-height: 1;
    }

    .session-del-btn:hover {
        color: #d93025;
        background: #fee2e2;
    }

    .empty-msg {
        text-align: center;
        padding: 60px 20px;
        color: var(--muted);
        font-size: 0.95rem;
    }

    /* ══════════ Responsive ══════════ */
    @media (max-width: 560px) {
        .breadcrumb { display: none; }

        .page-header {
            flex-direction: row;
            align-items: center;
            gap: 14px;
            margin: -20px -16px 20px;
            padding: 24px 20px;
            border-radius: 0 0 20px 20px;
            background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 60%, #40916c 100%);
        }

        .page-header .grade-badge {
            width: 52px;
            height: 52px;
            font-size: 0.88rem;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .page-header-text h1 {
            color: #fff;
            font-size: 1.35rem;
        }

        .page-header-text p {
            color: rgba(255,255,255,0.75);
            font-size: 0.82rem;
        }

        .tab-nav {
            margin-bottom: 16px;
            gap: 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 10px 10px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .year-grid {
            grid-template-columns: 1fr;
        }

        .mock-card {
            padding: 30px 20px;
        }

        /* ── Wrong summary mobile ── */
        .wrong-summary {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
            text-align: center;
            padding: 16px;
        }

        .wrong-summary-text {
            font-size: 0.9rem;
        }

        .wrong-summary .btn-row {
            justify-content: center;
        }

        /* ── Session card mobile (compact) ── */
        .session-list {
            gap: 6px;
        }

        .session-card {
            position: relative;
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto auto;
            align-items: center;
            gap: 0 10px;
            padding: 10px 12px;
            border-radius: 10px;
        }

        .session-mode {
            grid-row: 1;
            grid-column: 1;
            font-size: 0.68rem;
            padding: 1px 6px;
            border-radius: 4px;
        }

        .session-info {
            grid-row: 1;
            grid-column: 2;
            min-width: 0;
        }

        .session-label {
            font-size: 0.82rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-date {
            font-size: 0.7rem;
        }

        .session-card .session-del-form {
            grid-row: 1;
            grid-column: 3;
        }

        .session-stats {
            grid-row: 2;
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #eee;
        }

        .session-stats .session-score {
            font-size: 0.95rem;
        }

        .session-wrong-badge {
            font-size: 0.72rem;
            padding: 2px 7px;
        }

        .session-stats .session-link {
            margin-left: auto;
            font-size: 0.78rem;
            padding: 4px 10px;
        }
    }

    /* ══════════ Latest Questions (최신기출) ══════════ */
    .latest-add-btn {
        background: #f0f7ec;
        border: 1px dashed #97bc62;
        border-radius: 10px;
        padding: 10px 20px;
        font-size: 0.92rem;
        font-weight: 700;
        color: #2c5f2d;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.15s;
    }

    .latest-add-btn:hover {
        background: #e5f5e0;
        border-color: #2c5f2d;
    }

    .latest-form-wrap {
        background: #f8fcf5;
        border: 1px solid #d7e3d7;
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .latest-form-row {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 10px;
    }

    .latest-form-row label {
        min-width: 60px;
        font-size: 0.88rem;
        font-weight: 700;
        color: #555;
        padding-top: 8px;
    }

    .latest-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: inherit;
    }

    .latest-input-sm {
        flex: 0;
        width: 100px;
    }

    .latest-textarea {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: inherit;
        resize: vertical;
    }

    .latest-input:focus,
    .latest-textarea:focus {
        outline: none;
        border-color: #97bc62;
    }

    .latest-submit-btn {
        background: #2d8a4e;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 20px;
        font-size: 0.88rem;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
    }

    .latest-submit-btn:hover { background: #236b3e; }

    .latest-cancel-btn {
        background: #eee;
        color: #666;
        border: none;
        border-radius: 8px;
        padding: 8px 20px;
        font-size: 0.88rem;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
    }

    .latest-cancel-btn:hover { background: #ddd; }

    /* ── Registration Sub-tabs ── */
    .reg-subtab-btns {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 16px;
    }

    .reg-subtab-btn {
        flex: 1;
        padding: 10px 0;
        border: none;
        background: none;
        font-size: 0.9rem;
        font-weight: 700;
        color: #999;
        cursor: pointer;
        font-family: inherit;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: color 0.2s;
    }

    .reg-subtab-btn.active {
        color: #2d8a4e;
        border-bottom-color: #2d8a4e;
    }

    .reg-subtab-content {
        display: none;
    }

    .reg-subtab-content.active {
        display: block;
    }

    .clone-preview-box {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 16px;
        margin-top: 12px;
    }

    .clone-preview-text {
        font-weight: 700;
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 10px;
    }

    .clone-preview-choices {
        font-size: 0.9rem;
        line-height: 1.8;
        color: #333;
    }

    .clone-preview-choices .preview-choice {
        padding: 2px 0;
    }

    .clone-preview-choices .preview-choice.correct {
        color: #2d8a4e;
        font-weight: 600;
    }

    .clone-preview-answer {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #d93025;
        font-weight: 600;
    }

    .latest-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .latest-card {
        border: 1px solid #e8e8e8;
        border-radius: 14px;
        padding: 18px;
        background: #fff;
    }

    .latest-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .latest-badge {
        display: inline-block;
        font-size: 0.78rem;
        font-weight: 800;
        color: #fff;
        background: #3d9ed6;
        padding: 3px 10px;
        border-radius: 6px;
    }

    .latest-del-btn {
        background: none;
        border: 1px solid #ddd;
        color: #888;
        font-size: 0.78rem;
        font-weight: 700;
        cursor: pointer;
        padding: 3px 10px;
        border-radius: 6px;
        transition: color 0.15s, background 0.15s, border-color 0.15s;
        font-family: inherit;
    }

    .latest-del-btn:hover {
        color: #d93025;
        background: #fee2e2;
        border-color: #d93025;
    }

    .latest-edit-btn {
        background: none;
        border: 1px solid #ddd;
        color: #888;
        font-size: 0.78rem;
        font-weight: 700;
        cursor: pointer;
        padding: 3px 10px;
        border-radius: 6px;
        transition: color 0.15s, background 0.15s, border-color 0.15s;
        font-family: inherit;
    }

    .latest-edit-btn:hover {
        color: #3d9ed6;
        background: #e3f2fd;
        border-color: #3d9ed6;
    }

    .latest-year-edit-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        background: #f0f7ec;
        border: 1px solid #c8e4c2;
        border-radius: 12px;
        font-size: 0.82rem;
        font-weight: 700;
        color: #2c5f2d;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
        flex-shrink: 0;
        font-family: inherit;
    }

    .latest-year-edit-btn:hover {
        background: #e5f5e0;
        border-color: #2c5f2d;
    }

    .latest-year-section {
        margin-top: 20px;
        padding: 20px;
        background: #fafcf8;
        border: 1px solid #d7e3d7;
        border-radius: 14px;
    }

    .latest-year-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .latest-year-section-header h3 {
        font-size: 1.05rem;
        color: var(--forest);
    }

    .latest-text {
        font-size: 0.95rem;
        color: #333;
        line-height: 1.7;
        margin-bottom: 12px;
    }

    .latest-choices {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
    }

    .latest-choice {
        font-size: 0.88rem;
        color: #555;
        padding: 6px 12px;
        border-radius: 8px;
        background: #fafafa;
        border: 1px solid #eee;
    }

    .latest-choice.correct {
        background: #e8f5e9;
        border-color: #a5d6a7;
        color: #1d5536;
        font-weight: 700;
    }

    .latest-explanation {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.7;
        padding: 10px 14px;
        background: #fafafa;
        border-radius: 8px;
        border-left: 3px solid #97bc62;
    }

    @media (max-width: 560px) {
        /* ── Latest: year section ── */
        .latest-year-section {
            margin-top: 14px;
            padding: 14px;
            border-radius: 12px;
        }

        .latest-year-section-header {
            margin-bottom: 12px;
        }

        .latest-year-section-header h3 {
            font-size: 0.95rem;
        }

        /* ── Latest: question cards ── */
        .latest-list {
            gap: 10px;
        }

        .latest-card {
            padding: 14px;
            border-radius: 12px;
        }

        .latest-card-header {
            margin-bottom: 8px;
        }

        .latest-badge {
            font-size: 0.72rem;
            padding: 2px 8px;
            border-radius: 5px;
        }

        .latest-text {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .latest-choices {
            gap: 4px;
            margin-bottom: 8px;
        }

        .latest-choice {
            font-size: 0.82rem;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .latest-explanation {
            font-size: 0.8rem;
            line-height: 1.6;
            padding: 8px 12px;
            border-radius: 6px;
        }

        /* ── Latest: add button full width ── */
        .latest-add-btn {
            display: block;
            width: 100%;
            text-align: center;
            padding: 14px;
            font-size: 0.9rem;
            border-radius: 12px;
        }

        /* ── Latest: form ── */
        .latest-form-wrap {
            padding: 16px;
            border-radius: 14px;
            background: #f8fcf5;
        }

        .latest-form-row {
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .latest-form-row label {
            padding-top: 0;
            font-size: 0.82rem;
            font-weight: 800;
            color: #1d5536;
        }

        .latest-input-sm {
            width: 100%;
        }

        .latest-input,
        .latest-textarea,
        .latest-form-row select.latest-input {
            width: 100%;
            font-size: 0.9rem;
            padding: 10px 12px;
            border: 1.5px solid #d7e3d7;
            border-radius: 10px;
            background: #fff;
            box-sizing: border-box;
        }

        .latest-input:focus,
        .latest-textarea:focus,
        .latest-form-row select.latest-input:focus {
            border-color: #4caf7a;
            box-shadow: 0 0 0 3px rgba(76,175,122,0.12);
        }

        .latest-textarea {
            min-height: 80px;
        }

        .latest-submit-btn {
            width: 100%;
            padding: 12px;
            font-size: 0.92rem;
            border-radius: 10px;
        }

        .latest-cancel-btn {
            width: 100%;
            padding: 10px;
            font-size: 0.88rem;
            border-radius: 10px;
        }

        /* ── Latest: year card edit btn ── */
        .latest-year-edit-btn {
            width: 38px;
            font-size: 0.78rem;
            border-radius: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
    <div class="breadcrumb fade-up">
        <a href="{% url 'main:subject_list' %}">학년별 교과목</a>
        <span class="sep">/</span>
        <span>{{ subject.name }}</span>
    </div>

    <div class="page-header fade-up">
        <span class="grade-badge g{{ subject.grade }}">{{ subject.get_grade_display }}</span>
        <div class="page-header-text">
            <h1>{{ subject.name }}</h1>
            <p>{{ subject.get_grade_display }} {{ subject.get_semester_display }} &middot; {{ subject.category }}</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav fade-up">
        <button class="tab-btn{% if active_tab == 'study' %} active{% endif %}" data-tab="study" onclick="switchTab('study')">학습</button>
        <button class="tab-btn{% if active_tab == 'solve' %} active{% endif %}" data-tab="solve" onclick="switchTab('solve')">풀이</button>
        <button class="tab-btn{% if active_tab == 'mock' %} active{% endif %}" data-tab="mock" onclick="switchTab('mock')">모의고사</button>
        <button class="tab-btn{% if active_tab == 'wrong' %} active{% endif %}" data-tab="wrong" onclick="switchTab('wrong')">
            오답 노트
            {% if wrong_count > 0 %}<span class="tab-badge badge-wrong">{{ wrong_count }}</span>{% endif %}
        </button>
        <button class="tab-btn{% if active_tab == 'latest' %} active{% endif %}" data-tab="latest" onclick="switchTab('latest')">
            최신기출
            {% if latest_year_cards %}<span class="tab-badge" style="background:#3d9ed6;">{{ latest_year_cards|length }}</span>{% endif %}
        </button>
    </div>

    <!-- Tab 1: 학습 -->
    <div class="tab-content{% if active_tab == 'study' %} active{% endif %}" id="tab-study">
        {% if year_cards %}
        <div class="year-grid">
            {% for card in year_cards %}
            <div class="year-card fade-up delay-{{ forloop.counter }}">
                <div class="year-card-header">
                    <h3>{{ card.year }}년</h3>
                    <span class="q-count">{{ card.count }}문항</span>
                </div>
                <a class="mode-btn study" href="{% url 'exam:study_mode' subject.pk card.year %}">
                    <span class="mode-icon">&#128218;</span>
                    <span class="mode-info">
                        <span class="mode-name">학습모드</span>
                        <span class="mode-desc">정답을 확인하며 학습</span>
                    </span>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-msg">등록된 기출문제가 없습니다.</div>
        {% endif %}
    </div>

    <!-- Tab 2: 풀이 -->
    <div class="tab-content{% if active_tab == 'solve' %} active{% endif %}" id="tab-solve">
        {% if year_cards %}
        <div class="year-grid">
            {% for card in year_cards %}
            <div class="year-card fade-up delay-{{ forloop.counter }}">
                <div class="year-card-header">
                    <h3>{{ card.year }}년</h3>
                    <span class="q-count">{{ card.count }}문항</span>
                </div>
                <a class="mode-btn solve" href="{% url 'exam:exam_take' subject.pk card.year %}">
                    <span class="mode-icon">&#9998;</span>
                    <span class="mode-info">
                        <span class="mode-name">풀이모드</span>
                        <span class="mode-desc">시험처럼 풀고 채점</span>
                    </span>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-msg">등록된 기출문제가 없습니다.</div>
        {% endif %}
    </div>

    <!-- Tab 3: 모의고사 -->
    <div class="tab-content{% if active_tab == 'mock' %} active{% endif %}" id="tab-mock">
        <div class="mock-card fade-up">
            <h2>모의고사</h2>
            <p>{{ year_cards|length }}개 연도, 총 {{ total_questions }}문제에서<br>랜덤 25문제를 선별하여 출제합니다.</p>
            <a class="mock-start-btn" href="{% url 'exam:mock_exam_take' subject.pk %}">모의고사 시작</a>
        </div>
    </div>

    <!-- Tab 4: 오답 노트 -->
    <div class="tab-content{% if active_tab == 'wrong' %} active{% endif %}" id="tab-wrong">
        {% if wrong_count > 0 %}
        <div class="wrong-summary fade-up">
            <div class="wrong-summary-text">
                오답 <strong>{{ wrong_count }}</strong>문제
            </div>
            <div class="btn-row" style="display:flex; gap:8px;">
                <a class="wrong-summary-btn" style="background:#e5f5e0; color:#1d5536; border:1px solid #c8e4c2;" href="{% url 'exam:wrong_answers' subject.pk %}">전체 오답 보기</a>
                <a class="wrong-summary-btn" href="{% url 'exam:wrong_answers_retry' subject.pk %}">다시 도전</a>
            </div>
        </div>
        {% endif %}

        {% if exam_sessions %}
        <div class="session-list">
            {% for s in exam_sessions %}
            <div class="session-card fade-up">
                <span class="session-mode {{ s.mode }}">
                    {% if s.mode == 'mock' %}모의고사{% else %}풀이{% endif %}
                </span>
                <div class="session-info">
                    <div class="session-label">{{ s.mode_label }}</div>
                    <div class="session-date">{{ s.date|date:"Y.m.d H:i" }}</div>
                </div>
                <div class="session-stats">
                    <span class="session-score" style="color:{% if s.score >= 80 %}#2d8a4e{% elif s.score >= 60 %}#3d9ed6{% elif s.score >= 40 %}#e0943a{% else %}#d93025{% endif %};">{{ s.score }}점</span>
                    {% if s.wrong > 0 %}
                    <span class="session-wrong-badge">오답 {{ s.wrong }}</span>
                    <a class="session-link" href="{% url 'exam:wrong_answers_session' subject.pk s.session_id %}">문제 보기</a>
                    {% else %}
                    <span style="font-size:0.85rem; color:#2d8a4e; font-weight:600;">전문 정답</span>
                    {% endif %}
                </div>
                <form class="session-del-form" method="post" action="{% url 'exam:session_delete' subject.pk s.session_id %}" onsubmit="return confirm('이 시험 기록을 삭제하시겠습니까?');" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="session-del-btn" title="삭제">✕</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-msg">아직 풀이 기록이 없습니다.<br>풀이모드나 모의고사를 먼저 진행해보세요!</div>
        {% endif %}

    </div>

    <!-- Tab 5: 최신기출 -->
    <div class="tab-content{% if active_tab == 'latest' %} active{% endif %}" id="tab-latest">
        <!-- 연도별 카드 -->
        {% if latest_year_cards %}
        <div class="year-grid">
            {% for card in latest_year_cards %}
            <div class="year-card fade-up delay-{{ forloop.counter }}">
                <div class="year-card-header">
                    <h3>{{ card.year }}년</h3>
                    <span class="q-count">{{ card.count }}문항</span>
                </div>
                <div style="display:flex; gap:8px;">
                    <a class="mode-btn study" href="{% url 'exam:study_mode' subject.pk card.year %}" style="flex:1;">
                        <span class="mode-icon">&#128218;</span>
                        <span class="mode-info">
                            <span class="mode-name">학습모드</span>
                            <span class="mode-desc">정답을 확인하며 학습</span>
                        </span>
                    </a>
                    <button type="button" class="latest-year-edit-btn" onclick="toggleYearQuestions({{ card.year }})">수정</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-msg" style="margin-bottom:20px;">등록된 최신기출이 없습니다.<br>아래에서 문제를 등록해보세요!</div>
        {% endif %}

        <!-- 연도별 문제 목록 (숨김) -->
        {% regroup latest_questions by year as year_groups %}
        {% for group in year_groups %}
        <div class="latest-year-section" id="year-section-{{ group.grouper }}" style="display:none;">
            <div class="latest-year-section-header">
                <h3>{{ group.grouper }}년 문제 ({{ group.list|length }}문항)</h3>
                <button type="button" class="latest-cancel-btn" onclick="toggleYearQuestions({{ group.grouper }})">닫기</button>
            </div>
            <div class="latest-list">
                {% for q in group.list %}
                <div class="latest-card" id="lq-card-{{ q.pk }}">
                    <div id="lq-view-{{ q.pk }}">
                        <div class="latest-card-header">
                            <span class="latest-badge">{{ q.number }}번</span>
                            <div style="display:flex; gap:4px;">
                                <button type="button" class="latest-edit-btn" onclick="toggleEditForm({{ q.pk }})">수정</button>
                                <form method="post" action="{% url 'main:latest_question_delete' q.pk %}" onsubmit="return confirm('이 문제를 삭제하시겠습니까?');" style="margin:0;">
                                    {% csrf_token %}
                                    <button type="submit" class="latest-del-btn">삭제</button>
                                </form>
                            </div>
                        </div>
                        <div class="latest-text">{{ q.text }}</div>
                        <div class="latest-choices">
                            <div class="latest-choice{% if '1' in q.answer %} correct{% endif %}">① {{ q.choice_1 }}</div>
                            <div class="latest-choice{% if '2' in q.answer %} correct{% endif %}">② {{ q.choice_2 }}</div>
                            <div class="latest-choice{% if '3' in q.answer %} correct{% endif %}">③ {{ q.choice_3 }}</div>
                            <div class="latest-choice{% if '4' in q.answer %} correct{% endif %}">④ {{ q.choice_4 }}</div>
                        </div>
                        {% if q.explanation %}
                        <div class="latest-explanation">{{ q.explanation }}</div>
                        {% endif %}
                    </div>
                    <div id="lq-edit-{{ q.pk }}" style="display:none;">
                        <form method="post" action="{% url 'main:latest_question_update' q.pk %}">
                            {% csrf_token %}
                            <div class="latest-form-row">
                                <label>연도</label>
                                <input type="number" name="year" value="{{ q.year }}" class="latest-input latest-input-sm" required>
                            </div>
                            <div class="latest-form-row">
                                <label>문제</label>
                                <textarea name="text" class="latest-textarea" rows="3" required>{{ q.text }}</textarea>
                            </div>
                            <div class="latest-form-row">
                                <label>보기 ①</label>
                                <input type="text" name="choice_1" class="latest-input" value="{{ q.choice_1 }}">
                            </div>
                            <div class="latest-form-row">
                                <label>보기 ②</label>
                                <input type="text" name="choice_2" class="latest-input" value="{{ q.choice_2 }}">
                            </div>
                            <div class="latest-form-row">
                                <label>보기 ③</label>
                                <input type="text" name="choice_3" class="latest-input" value="{{ q.choice_3 }}">
                            </div>
                            <div class="latest-form-row">
                                <label>보기 ④</label>
                                <input type="text" name="choice_4" class="latest-input" value="{{ q.choice_4 }}">
                            </div>
                            <div class="latest-form-row">
                                <label>정답</label>
                                <select name="answer" class="latest-input latest-input-sm">
                                    <option value="1"{% if q.answer == '1' %} selected{% endif %}>①</option>
                                    <option value="2"{% if q.answer == '2' %} selected{% endif %}>②</option>
                                    <option value="3"{% if q.answer == '3' %} selected{% endif %}>③</option>
                                    <option value="4"{% if q.answer == '4' %} selected{% endif %}>④</option>
                                </select>
                            </div>
                            <div class="latest-form-row">
                                <label>해설</label>
                                <textarea name="explanation" class="latest-textarea" rows="3">{{ q.explanation }}</textarea>
                            </div>
                            <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:12px;">
                                <button type="button" class="latest-cancel-btn" onclick="toggleEditForm({{ q.pk }})">취소</button>
                                <button type="submit" class="latest-submit-btn">저장</button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- ══════════ 등록 서브탭 ══════════ -->
        <div class="reg-subtabs" style="margin-top:20px;">
            <div class="reg-subtab-btns">
                <button type="button" class="reg-subtab-btn active" data-reg="new" onclick="switchRegTab('new')">신규 등록</button>
                <button type="button" class="reg-subtab-btn" data-reg="existing" onclick="switchRegTab('existing')">기존 기출 출제</button>
            </div>

            <!-- 신규 등록 -->
            <div class="reg-subtab-content active" id="reg-new">
                <div class="latest-form-wrap">
                    <form method="post" action="{% url 'main:latest_question_create' subject.pk %}">
                        {% csrf_token %}
                        <div class="latest-form-row">
                            <label>연도</label>
                            <input type="number" name="year" id="latest-year-input" class="latest-input latest-input-sm" required>
                        </div>
                        <div class="latest-form-row">
                            <label>문제</label>
                            <textarea name="text" class="latest-textarea" rows="3" placeholder="문제 내용을 입력하세요" required></textarea>
                        </div>
                        <div class="latest-form-row">
                            <label>보기 ①</label>
                            <input type="text" name="choice_1" class="latest-input" placeholder="보기 1 (비우면 - 처리)">
                        </div>
                        <div class="latest-form-row">
                            <label>보기 ②</label>
                            <input type="text" name="choice_2" class="latest-input" placeholder="보기 2 (비우면 - 처리)">
                        </div>
                        <div class="latest-form-row">
                            <label>보기 ③</label>
                            <input type="text" name="choice_3" class="latest-input" placeholder="보기 3 (비우면 - 처리)">
                        </div>
                        <div class="latest-form-row">
                            <label>보기 ④</label>
                            <input type="text" name="choice_4" class="latest-input" placeholder="보기 4 (비우면 - 처리)">
                        </div>
                        <div class="latest-form-row">
                            <label>정답</label>
                            <select name="answer" class="latest-input latest-input-sm">
                                <option value="1">①</option>
                                <option value="2">②</option>
                                <option value="3">③</option>
                                <option value="4">④</option>
                            </select>
                        </div>
                        <div class="latest-form-row">
                            <label>해설</label>
                            <textarea name="explanation" class="latest-textarea" rows="3" placeholder="해설 (선택)"></textarea>
                        </div>
                        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:12px;">
                            <button type="submit" class="latest-submit-btn">등록</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 기존 기출 출제 -->
            <div class="reg-subtab-content" id="reg-existing">
                <div class="latest-form-wrap">
                    <form method="post" action="{% url 'main:latest_question_clone' subject.pk %}" id="clone-form">
                        {% csrf_token %}
                        <input type="hidden" name="source_id" id="clone-source-id">
                        <div class="latest-form-row">
                            <label>등록연도</label>
                            <input type="number" name="target_year" id="clone-target-year" class="latest-input latest-input-sm" required>
                        </div>
                        <div class="latest-form-row">
                            <label>출제연도</label>
                            <select id="clone-year-select" class="latest-input latest-input-sm" onchange="loadQuestionList()">
                                <option value="">선택</option>
                            </select>
                        </div>
                        <div class="latest-form-row">
                            <label>문항</label>
                            <select id="clone-question-select" class="latest-input" onchange="showQuestionPreview()">
                                <option value="">출제연도를 먼저 선택하세요</option>
                            </select>
                        </div>
                        <!-- 문제 미리보기 -->
                        <div id="clone-preview" style="display:none;">
                            <div class="clone-preview-box">
                                <div class="clone-preview-text" id="clone-preview-text"></div>
                                <div class="clone-preview-choices" id="clone-preview-choices"></div>
                                <div class="clone-preview-answer" id="clone-preview-answer"></div>
                            </div>
                            <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:12px;">
                                <button type="submit" class="latest-submit-btn">이 문제 등록</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(function(el) {
            el.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(function(el) {
            el.classList.remove('active');
        });
        document.getElementById('tab-' + tabName).classList.add('active');
        var activeBtn = document.querySelector('[data-tab="' + tabName + '"]');
        activeBtn.classList.add('active');
        activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        history.replaceState(null, '', '?tab=' + tabName);
    }

    // 페이지 로드 시 활성 탭이 보이도록 스크롤
    (function() {
        var activeBtn = document.querySelector('.tab-btn.active');
        if (activeBtn) {
            activeBtn.scrollIntoView({ block: 'nearest', inline: 'center' });
        }
    })();

    /* 연도 초기화: last_year 파라미터 > 현재 연도 */
    (function() {
        var params = new URLSearchParams(window.location.search);
        var lastYear = params.get('last_year');
        var defaultYear = lastYear || new Date().getFullYear();
        var yearInput = document.getElementById('latest-year-input');
        if (yearInput) yearInput.value = defaultYear;
        var cloneYear = document.getElementById('clone-target-year');
        if (cloneYear) cloneYear.value = defaultYear;
        var sub = params.get('sub');
        if (sub) switchRegTab(sub);
    })();

    /* ── 등록 서브탭 전환 ── */
    function switchRegTab(tab) {
        document.querySelectorAll('.reg-subtab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.reg-subtab-content').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('[data-reg="' + tab + '"]').classList.add('active');
        document.getElementById('reg-' + tab).classList.add('active');
        if (tab === 'existing') loadExistingYears();
    }

    /* ── 기존 기출: 연도 목록 로드 ── */
    var _questionsCache = {};
    var subjectPk = {{ subject.pk }};

    function loadExistingYears() {
        var sel = document.getElementById('clone-year-select');
        if (sel.options.length > 1) return;
        fetch('/subjects/' + subjectPk + '/api/years/')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                data.years.forEach(function(y) {
                    var opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y + '년';
                    sel.appendChild(opt);
                });
            });
    }

    /* ── 기존 기출: 문항 목록 로드 ── */
    function loadQuestionList() {
        var year = document.getElementById('clone-year-select').value;
        var qSel = document.getElementById('clone-question-select');
        document.getElementById('clone-preview').style.display = 'none';
        qSel.innerHTML = '<option value="">불러오는 중...</option>';
        if (!year) {
            qSel.innerHTML = '<option value="">출제연도를 먼저 선택하세요</option>';
            return;
        }
        fetch('/subjects/' + subjectPk + '/api/questions/' + year + '/')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                _questionsCache = {};
                qSel.innerHTML = '<option value="">문항을 선택하세요</option>';
                data.questions.forEach(function(q) {
                    _questionsCache[q.id] = q;
                    var opt = document.createElement('option');
                    opt.value = q.id;
                    opt.textContent = q.number + '번 - ' + q.text.substring(0, 40) + (q.text.length > 40 ? '...' : '');
                    qSel.appendChild(opt);
                });
            });
    }

    /* ── 기존 기출: 미리보기 ── */
    function showQuestionPreview() {
        var qId = document.getElementById('clone-question-select').value;
        var preview = document.getElementById('clone-preview');
        if (!qId || !_questionsCache[qId]) {
            preview.style.display = 'none';
            return;
        }
        var q = _questionsCache[qId];
        document.getElementById('clone-source-id').value = q.id;
        document.getElementById('clone-preview-text').textContent = q.number + '. ' + q.text;
        var answerNums = q.answer.split(',');
        var choicesHtml = '';
        var labels = ['①', '②', '③', '④'];
        var fields = ['choice_1', 'choice_2', 'choice_3', 'choice_4'];
        for (var i = 0; i < 4; i++) {
            var isCorrect = answerNums.indexOf(String(i + 1)) >= 0;
            choicesHtml += '<div class="preview-choice' + (isCorrect ? ' correct' : '') + '">' +
                labels[i] + ' ' + q[fields[i]] + '</div>';
        }
        document.getElementById('clone-preview-choices').innerHTML = choicesHtml;
        var answerLabels = answerNums.map(function(n) { return labels[parseInt(n) - 1] || n; });
        document.getElementById('clone-preview-answer').textContent = '정답: ' + answerLabels.join(', ');
        preview.style.display = '';
    }

    function toggleYearQuestions(year) {
        var section = document.getElementById('year-section-' + year);
        document.querySelectorAll('.latest-year-section').forEach(function(el) {
            if (el.id !== 'year-section-' + year) {
                el.style.display = 'none';
            }
        });
        if (section.style.display === 'none') {
            section.style.display = '';
        } else {
            section.style.display = 'none';
        }
    }

    function toggleEditForm(pk) {
        var view = document.getElementById('lq-view-' + pk);
        var edit = document.getElementById('lq-edit-' + pk);
        if (edit.style.display === 'none') {
            view.style.display = 'none';
            edit.style.display = '';
        } else {
            view.style.display = '';
            edit.style.display = 'none';
        }
    }
</script>
{% endblock %}
